<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蓝白图片浏览器 - 优化版</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f7ff 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
        }

        /* 按钮样式 */
        .top-button {
            position: fixed;
            z-index: 1000;
            padding: 10px 16px;
            color: white;
            border: none;
            border-radius: 8px;
            font-family: '微软雅黑', sans-serif;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .top-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }

        .top-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
        }

        /* 返回按钮样式 */
        #backButton {
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }

        /* 布局设置按钮样式 */
        #layoutButton {
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px 0;
        }

        h1 {
            color: #1a73e8;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .subtitle {
            color: #5f7d9c;
            font-size: 1.1rem;
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(66, 133, 244, 0.15);
            overflow: hidden;
            margin-bottom: 30px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(66, 133, 244, 0.25);
        }

        /* 蓝白配色优化 */
        .folder-selector {
            padding: 30px;
            text-align: center;
            background: linear-gradient(to right, #4285f4, #1a73e8);
            color: white;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .custom-file-btn {
            display: inline-block;
            padding: 15px 30px;
            background: white;
            color: #4285f4;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1.1rem;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
            transition: all 0.3s ease;
        }

        .custom-file-btn:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
        }
        

        .file-info {
            margin-top: 15px;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        #imageContainer {
            display: flex;
            flex-direction: column;
            gap: 30px;
            padding: 25px;
        }

        .folder-group {
            background: #f8fbff;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.1);
        }

        .folder-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e3f2fd;
        }

        .folder-icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            fill: #1a73e8;
        }

        .folder-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1a73e8;
        }

        .group-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .image-item {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.2);
            transition: all 0.3s ease;
            background: white;
            position: relative;
            min-height: 240px; /* 为加载动画预留空间 */
            cursor: pointer;
        }

        .image-item:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 25px rgba(66, 133, 244, 0.3);
        }

        .image-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0; /* 初始状态为透明 */
        }

        .image-item img.loaded {
            opacity: 1; /* 加载完成后显示 */
        }

        .image-name {
            padding: 12px;
            text-align: center;
            background: #f0f8ff;
            color: #1a73e8;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 加载动画 */
        .image-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
        }

        .image-loading::after {
            content: "";
            display: block;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid #e3f2fd;
            border-color: #e3f2fd transparent #e3f2fd transparent;
            animation: loading 1.2s linear infinite;
        }

        @keyframes loading {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-images {
            text-align: center;
            padding: 50px;
            color: #5f7d9c;
            font-size: 1.2rem;
            grid-column: 1 / -1;
        }

        .image-count {
            text-align: center;
            padding: 15px;
            color: #1a73e8;
            font-weight: 600;
            font-size: 1.1rem;
            background: rgba(26, 115, 232, 0.05);
            border-radius: 0 0 16px 16px;
        }

        .folder-count {
            margin-top: 5px;
            font-size: 0.9rem;
            color: #5f7d9c;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #5f7d9c;
            font-size: 0.9rem;
            margin-top: 30px;
        }

        /* 悬浮放大效果 */
        .zoom-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .zoom-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .zoom-image-container {
            max-width: 90%;
            max-height: 90%;
            position: relative;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            overflow: hidden;
            transform: scale(0.95);
            transition: transform 0.3s ease;
            
        }

        .zoom-overlay.active .zoom-image-container {
            transform: scale(1);
        }

        .zoom-image {
            max-width: 100%;
            max-height: 80vh;
            display: block;
        }

        .zoom-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .zoom-close:hover {
            background: white;
            transform: rotate(90deg);
        }

        .zoom-close::before, .zoom-close::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 2px;
            background: #1a73e8;
        }

        .zoom-close::before {
            transform: rotate(45deg);
        }

        .zoom-close::after {
            transform: rotate(-45deg);
        }

        /* 上一张/下一张按钮样式 */
        .zoom-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            z-index: 1001;
        }

        .zoom-nav:hover {
            background: white;
            transform: translateY(-50%) scale(1.1);
        }

        .zoom-prev {
            left: 20px;
        }

        .zoom-next {
            right: 20px;
        }

        .zoom-nav svg {
            width: 24px;
            height: 24px;
            fill: #1a73e8;
        }

        .zoom-nav.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .zoom-nav.disabled:hover {
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.8);
        }

        /* 图片计数器 */
        .zoom-counter {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.8);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: #1a73e8;
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* 布局设置面板 - 优化排版 */
        .layout-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .layout-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .layout-panel {
            background: white;
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
            position: relative;
            height: 60vh;
            overflow-y: auto;
        }

        .layout-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .layout-title {
            font-size: 1.5rem;
            color: #1a73e8;
            font-weight: 600;
        }

        .layout-close {
            width: 30px;
            height: 30px;
            cursor: pointer;
            position: relative;
        }

        .layout-close::before, .layout-close::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 2px;
            background: #5f7d9c;
        }

        .layout-close::before {
            transform: rotate(45deg);
        }

        .layout-close::after {
            transform: rotate(-45deg);
        }

        /* 布局选项分类 */
        .layout-category {
            margin-bottom: 30px;
        }

        .category-title {
            font-size: 1.2rem;
            color: #1a73e8;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e3f2fd;
            font-weight: 600;
        }

        .layout-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .layout-option {
            background: #f8fbff;
            border: 2px solid #bbdefb;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .layout-option:hover {
            background: #e3f2fd;
            border-color: #90caf9;
        }

        .layout-option.active {
            background: #d1e7ff;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }

        .layout-label {
            font-size: 1.1rem;
            color: #1a73e8;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .layout-grid {
            display: grid;
            gap: 5px;
            margin: 0 auto;
            width: 80px;
            height: 80px;
        }

        .grid-cell {
            background: #bbdefb;
            border-radius: 3px;
        }

        .layout-option[data-layout="auto"] .layout-grid {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
        }

        .layout-option[data-layout="2x2"] .layout-grid {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
        }

        .layout-option[data-layout="3x3"] .layout-grid {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
        }

        .layout-option[data-layout="4x4"] .layout-grid {
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
        }

        .layout-option[data-layout="2x3"] .layout-grid {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(3, 1fr);
        }

        .layout-option[data-layout="3x2"] .layout-grid {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
        }

        .layout-option[data-layout="4x3"] .layout-grid {
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(3, 1fr);
        }

        .layout-option[data-layout="3x4"] .layout-grid {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(4, 1fr);
        }

        .layout-description {
            font-size: 0.9rem;
            color: #5f7d9c;
            text-align: center;
            margin-top: 10px;
        }

        .layout-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }

        .layout-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .layout-apply {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
        }

        .layout-apply:hover {
            background: linear-gradient(135deg, #1976D2 0%, #0d47a1 100%);
        }

        .layout-cancel {
            background: #f5f5f5;
            color: #5f7d9c;
        }

        .layout-cancel:hover {
            background: #e0e0e0;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .group-images {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 15px;
            }
            
            .layout-options {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .zoom-nav {
                width: 40px;
                height: 40px;
            }
            
            .zoom-prev {
                left: 10px;
            }
            
            .zoom-next {
                right: 10px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.8rem;
            }
            
            .group-images {
                grid-template-columns: 1fr;
            }
            
            .custom-file-btn {
                padding: 12px 25px;
                font-size: 1rem;
            }
            
            .layout-options {
                grid-template-columns: 1fr;
            }
            
            .zoom-nav {
                width: 35px;
                height: 35px;
            }
            
            .zoom-nav svg {
                width: 18px;
                height: 18px;
            }
        }
    </style>
</head>
<body>
    <!-- 返回按钮 -->
    <button id="backButton" class="top-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
        </svg>
        返回主页
    </button>
    
    <!-- 布局设置按钮 - 确保在右上角 -->
    <button id="layoutButton" class="top-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zM1 10.5A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3z"/>
        </svg>
        布局设置
    </button>

    <div class="container">
        <header>
            <h1>蓝白图片浏览器</h1>
            <p class="subtitle">轻松浏览本地文件夹中的图片（优化加载性能）</p>
        </header>
        
        <div class="card">
            <div class="folder-selector">
                <div class="file-input-wrapper">
                    <input type="file" 
                           id="folderInput" 
                           webkitdirectory 
                           directory 
                           multiple 
                           accept="image/*"
                           required>
                    <div class="custom-file-btn">选择图片文件夹</div>
                </div>
                <p class="file-info">支持 JPG, PNG, GIF, WEBP 等常见图片格式 | 自动识别子文件夹中的图片</p>
            </div>
            
            <div id="imageContainer">
                <div class="no-images">请选择文件夹查看图片</div>
            </div>
            
            <div class="image-count" id="imageCount">0 张图片</div>
            <div class="folder-count" id="folderCount">0 个子文件夹</div>
        </div>
        
        <footer>
            <p>© 2023 蓝白图片浏览器 | 使用现代浏览器以获得最佳体验</p>
        </footer>
    </div>
    
    <!-- 悬浮放大层 -->
    <div class="zoom-overlay" id="zoomOverlay">
        <div class="zoom-nav zoom-prev" id="zoomPrev">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
            </svg>
        </div>
        
        <div class="zoom-image-container">
            <img class="zoom-image" id="zoomImage" src="" alt="放大预览">
            <div class="zoom-close" id="zoomClose"></div>
            <div class="zoom-counter" id="zoomCounter"></div>
        </div>
        
        <div class="zoom-nav zoom-next" id="zoomNext">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
            </svg>
        </div>
    </div>
    
    <!-- 布局设置面板 - 优化排版 -->
    <div class="layout-overlay" id="layoutOverlay">
        <div class="layout-panel">
            <div class="layout-header">
                <div class="layout-title">图片布局设置</div>
                <div class="layout-close" id="layoutClose"></div>
            </div>
            
            <!-- 自动布局分类 -->
            <div class="layout-category">
                <div class="category-title">自动布局</div>
                <div class="layout-options">
                    <div class="layout-option active" data-layout="auto">
                        <div>
                            <div class="layout-label">自动布局</div>
                            <div class="layout-grid">
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                            </div>
                        </div>
                        <div class="layout-description">响应式布局，自动适应屏幕</div>
                    </div>
                </div>
            </div>
            
            <!-- 方阵布局分类 -->
            <div class="layout-category">
                <div class="category-title">方阵布局</div>
                <div class="layout-options">
                    <div class="layout-option" data-layout="2x2">
                        <div>
                            <div class="layout-label">2×2</div>
                            <div class="layout-grid">
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                            </div>
                        </div>
                        <div class="layout-description">每行2张图片</div>
                    </div>
                    
                    <div class="layout-option" data-layout="3x3">
                        <div>
                            <div class="layout-label">3×3</div>
                            <div class="layout-grid">
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                            </div>
                        </div>
                        <div class="layout-description">每行3张图片</div>
                    </div>
                    
                    <div class="layout-option" data-layout="4x4">
                        <div>
                            <div class="layout-label">4×4</div>
                            <div class="layout-grid">
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                            </div>
                        </div>
                        <div class="layout-description">每行4张图片</div>
                    </div>
                </div>
            </div>
            
            <!-- 矩阵布局分类 -->
            <div class="layout-category">
                <div class="category-title">矩阵布局</div>
                <div class="layout-options">
                    <div class="layout-option" data-layout="2x3">
                        <div>
                            <div class="layout-label">2×3</div>
                            <div class="layout-grid">
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                            </div>
                        </div>
                        <div class="layout-description">每行2张图片</div>
                    </div>
                    
                    <div class="layout-option" data-layout="3x2">
                        <div>
                            <div class="layout-label">3×2</div>
                            <div class="layout-grid">
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                            </div>
                        </div>
                        <div class="layout-description">每行3张图片</div>
                    </div>
                    
                    <div class="layout-option" data-layout="4x3">
                        <div>
                            <div class="layout-label">4×3</div>
                            <div class="layout-grid">
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                            </div>
                        </div>
                        <div class="layout-description">每行4张图片</div>
                    </div>
                    
                    <div class="layout-option" data-layout="3x4">
                        <div>
                            <div class="layout-label">3×4</div>
                            <div class="layout-grid">
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                                <div class="grid-cell"></div>
                            </div>
                        </div>
                        <div class="layout-description">每行3张图片</div>
                    </div>
                </div>
            </div>
            
            <div class="layout-actions">
                <button class="layout-btn layout-cancel" id="layoutCancel">取消</button>
                <button class="layout-btn layout-apply" id="layoutApply">应用布局</button>
            </div>
        </div>
    </div>

    <script>
        const folderInput = document.getElementById('folderInput');
        const imageContainer = document.getElementById('imageContainer');
        const imageCount = document.getElementById('imageCount');
        const folderCount = document.getElementById('folderCount');
        const zoomOverlay = document.getElementById('zoomOverlay');
        const zoomImage = document.getElementById('zoomImage');
        const zoomClose = document.getElementById('zoomClose');
        const zoomPrev = document.getElementById('zoomPrev');
        const zoomNext = document.getElementById('zoomNext');
        const zoomCounter = document.getElementById('zoomCounter');
        const backButton = document.getElementById('backButton');
        const layoutButton = document.getElementById('layoutButton');
        const layoutOverlay = document.getElementById('layoutOverlay');
        const layoutClose = document.getElementById('layoutClose');
        const layoutCancel = document.getElementById('layoutCancel');
        const layoutApply = document.getElementById('layoutApply');
        const layoutOptions = document.querySelectorAll('.layout-option');
        
        // 当前布局设置（默认为自动布局）
        let currentLayout = 'auto';
        
        // 用于存储所有图片数据
        let allImagesData = [];
        let currentImageIndex = 0;
        let currentFolderImages = [];
        
        // 图片加载队列控制
        let loadingQueue = [];
        let isProcessingQueue = false;
        const MAX_CONCURRENT_LOADS = 3;
        
        // 返回按钮功能
        backButton.addEventListener('click', () => {
            // 清空图片容器
            imageContainer.innerHTML = '<div class="no-images">请选择文件夹查看图片</div>';
            // 重置图片计数
            imageCount.textContent = '0 张图片';
            folderCount.textContent = '0 个子文件夹';
            // 重置文件输入
            folderInput.value = '';
            // 清空图片数据
            allImagesData = [];
            // 清空加载队列
            loadingQueue = [];
        });
        
        // 布局设置按钮
        layoutButton.addEventListener('click', () => {
            layoutOverlay.classList.add('active');
        });
        
        // 关闭布局设置面板
        layoutClose.addEventListener('click', () => {
            layoutOverlay.classList.remove('active');
        });
        
        layoutCancel.addEventListener('click', () => {
            layoutOverlay.classList.remove('active');
        });
        
        // 点击布局选项
        layoutOptions.forEach(option => {
            option.addEventListener('click', () => {
                // 移除所有选项的active类
                layoutOptions.forEach(opt => opt.classList.remove('active'));
                // 为当前选项添加active类
                option.classList.add('active');
                // 更新当前布局
                currentLayout = option.dataset.layout;
            });
        });
        
        // 应用布局
        layoutApply.addEventListener('click', () => {
            layoutOverlay.classList.remove('active');
            applyLayout(currentLayout);
            // 布局变化后重新检查可见图片
            setTimeout(() => {
                checkVisibleImages();
            }, 300);
        });
        
        // 应用布局函数
        function applyLayout(layout) {
            const groupImages = document.querySelectorAll('.group-images');
            
            groupImages.forEach(group => {
                switch(layout) {
                    case 'auto':
                        group.style.gridTemplateColumns = 'repeat(auto-fill, minmax(250px, 1fr))';
                        break;
                    case '2x2':
                        group.style.gridTemplateColumns = 'repeat(2, 1fr)';
                        break;
                    case '3x3':
                        group.style.gridTemplateColumns = 'repeat(3, 1fr)';
                        break;
                    case '4x4':
                        group.style.gridTemplateColumns = 'repeat(4, 1fr)';
                        break;
                    case '2x3':
                        group.style.gridTemplateColumns = 'repeat(2, 1fr)';
                        break;
                    case '3x2':
                        group.style.gridTemplateColumns = 'repeat(3, 1fr)';
                        break;
                    case '4x3':
                        group.style.gridTemplateColumns = 'repeat(4, 1fr)';
                        break;
                    case '3x4':
                        group.style.gridTemplateColumns = 'repeat(3, 1fr)';
                        break;
                    default:
                        group.style.gridTemplateColumns = 'repeat(auto-fill, minmax(250px, 1fr))';
                }
            });
        }
        
        // 关闭悬浮放大层
        zoomClose.addEventListener('click', () => {
            zoomOverlay.classList.remove('active');
        });
        
        // 点击悬浮层任意位置关闭
        zoomOverlay.addEventListener('click', (e) => {
            if (e.target === zoomOverlay) {
                zoomOverlay.classList.remove('active');
            }
        });
        
        // 上一张图片
        zoomPrev.addEventListener('click', () => {
            if (currentImageIndex > 0) {
                currentImageIndex--;
                showZoomImage();
                // 预加载相邻图片
                preloadAdjacentImages();
            }
        });
        
        // 下一张图片
        zoomNext.addEventListener('click', () => {
            if (currentImageIndex < currentFolderImages.length - 1) {
                currentImageIndex++;
                showZoomImage();
                // 预加载相邻图片
                preloadAdjacentImages();
            }
        });
        
        // 显示放大图片
        function showZoomImage() {
            if (currentFolderImages.length === 0) return;
            
            const imageData = currentFolderImages[currentImageIndex];
            
            // 添加加载动画
            zoomImage.style.opacity = '0';
            
            // 使用setTimeout确保动画效果
            setTimeout(() => {
                zoomImage.src = imageData.url;
                zoomCounter.textContent = `${currentImageIndex + 1} / ${currentFolderImages.length}`;
                
                // 图片加载完成后显示
                zoomImage.onload = function() {
                    zoomImage.style.opacity = '1';
                };
            }, 50);
            
            // 更新按钮状态
            zoomPrev.classList.toggle('disabled', currentImageIndex === 0);
            zoomNext.classList.toggle('disabled', currentImageIndex === currentFolderImages.length - 1);
        }
        
        // 预加载相邻图片
        function preloadAdjacentImages() {
            // 预加载前一张图片
            if (currentImageIndex > 0) {
                const prevImage = new Image();
                prevImage.src = currentFolderImages[currentImageIndex - 1].url;
            }
            
            // 预加载后一张图片
            if (currentImageIndex < currentFolderImages.length - 1) {
                const nextImage = new Image();
                nextImage.src = currentFolderImages[currentImageIndex + 1].url;
            }
        }
        
        // 检查可见图片并进行加载
        function checkVisibleImages() {
            const images = document.querySelectorAll('.image-item img:not(.loaded)');
            
            images.forEach(img => {
                const rect = img.getBoundingClientRect();
                const isVisible = (
                    rect.top >= 0 &&
                    rect.left >= 0 &&
                    rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) * 1.5 && // 提前加载
                    rect.right <= (window.innerWidth || document.documentElement.clientWidth) * 1.5
                );
                
                if (isVisible) {
                    // 添加到加载队列
                    addToLoadingQueue(img);
                }
            });
            
            // 启动队列处理
            processLoadingQueue();
        }
        
        // 添加到加载队列
        function addToLoadingQueue(imgElement) {
            if (!loadingQueue.includes(imgElement) && imgElement.dataset.src) {
                loadingQueue.push(imgElement);
            }
        }
        
        // 处理加载队列
        function processLoadingQueue() {
            if (isProcessingQueue || loadingQueue.length === 0) return;
            
            isProcessingQueue = true;
            let processed = 0;
            const processNext = () => {
                processed++;
                
                // 当一批处理完成时
                if (processed === Math.min(MAX_CONCURRENT_LOADS, loadingQueue.length)) {
                    // 从队列中移除已处理的元素
                    loadingQueue.splice(0, processed);
                    isProcessingQueue = false;
                    
                    // 如果队列中还有元素，继续处理
                    if (loadingQueue.length > 0) {
                        setTimeout(() => {
                            processLoadingQueue();
                        }, 100);
                    }
                }
            };
            
            // 一次处理最多MAX_CONCURRENT_LOADS个图片
            for (let i = 0; i < Math.min(MAX_CONCURRENT_LOADS, loadingQueue.length); i++) {
                const imgElement = loadingQueue[i];
                
                if (imgElement.dataset.src) {
                    const loadImage = new Promise((resolve) => {
                        const img = new Image();
                        img.onload = function() {
                            imgElement.src = imgElement.dataset.src;
                            imgElement.classList.add('loaded');
                            delete imgElement.dataset.src;
                            
                            // 移除加载动画
                            const loadingElement = imgElement.parentNode.querySelector('.image-loading');
                            if (loadingElement) {
                                loadingElement.remove();
                            }
                            
                            resolve();
                        };
                        img.onerror = function() {
                            // 加载失败也移除加载动画
                            const loadingElement = imgElement.parentNode.querySelector('.image-loading');
                            if (loadingElement) {
                                loadingElement.remove();
                            }
                            // 设置一个错误占位图
                            imgElement.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23ccc' d='M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z'/%3E%3C/svg%3E";
                            imgElement.classList.add('loaded');
                            resolve();
                        };
                        img.src = imgElement.dataset.src;
                    });
                    
                    loadImage.finally(processNext);
                } else {
                    processNext();
                }
            }
        }
        
        // 使用Intersection Observer API实现懒加载
        let observer;
        function initIntersectionObserver() {
            if ('IntersectionObserver' in window) {
                observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            addToLoadingQueue(img);
                            observer.unobserve(img);
                        }
                    });
                    processLoadingQueue();
                }, {
                    rootMargin: '0px 0px 200px 0px' // 提前200px加载
                });
            }
        }
        
        folderInput.addEventListener('change', (e) => {
            // 清空现有内容
            imageContainer.innerHTML = '';
            allImagesData = [];
            loadingQueue = [];
            
            // 初始化Intersection Observer
            if (!observer) {
                initIntersectionObserver();
            }
            
            const files = Array.from(e.target.files);
            
            // 过滤非图片文件
            const imageFiles = files.filter(file => 
                file.type.startsWith('image/')
            );
            
            // 按文件夹分组图片
            const folderGroups = {};
            const folders = new Set();
            
            imageFiles.forEach(file => {
                let folderPath = '';
                if (file.webkitRelativePath) {
                    const pathParts = file.webkitRelativePath.split('/');
                    // 排除根目录
                    if (pathParts.length > 1) {
                        // 获取所有父级文件夹
                        let currentPath = '';
                        for (let i = 0; i < pathParts.length - 1; i++) {
                            currentPath += (currentPath ? '/' : '') + pathParts[i];
                            folders.add(currentPath);
                        }
                        folderPath = pathParts.slice(0, -1).join('/');
                    }
                }
                
                if (!folderGroups[folderPath]) {
                    folderGroups[folderPath] = [];
                }
                folderGroups[folderPath].push(file);
            });
            
            // 更新图片计数
            imageCount.textContent = `${imageFiles.length} 张图片`;
            folderCount.textContent = `${folders.size} 个子文件夹`;
            
            if (imageFiles.length === 0) {
                imageContainer.innerHTML = '<div class="no-images">文件夹中没有找到图片文件</div>';
                return;
            }
            
            // 按文件夹路径排序（根目录在最前）
            const sortedFolderPaths = Object.keys(folderGroups).sort((a, b) => {
                if (a === '') return -1; // 根目录在最前
                if (b === '') return 1;
                return a.localeCompare(b);
            });
            
            // 创建文件夹分组容器
            sortedFolderPaths.forEach(folderPath => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'folder-group';
                
                // 创建文件夹标题
                const headerDiv = document.createElement('div');
                headerDiv.className = 'folder-header';
                
                // 文件夹图标
                const folderIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                folderIcon.setAttribute('class', 'folder-icon');
                folderIcon.setAttribute('viewBox', '0 0 24 24');
                folderIcon.innerHTML = `
                    <path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
                `;
                
                const folderName = document.createElement('div');
                folderName.className = 'folder-name';
                folderName.textContent = folderPath || '根目录';
                
                headerDiv.appendChild(folderIcon);
                headerDiv.appendChild(folderName);
                groupDiv.appendChild(headerDiv);
                
                // 创建图片容器
                const imagesContainer = document.createElement('div');
                imagesContainer.className = 'group-images';
                
                // 按文件名排序图片
                folderGroups[folderPath].sort((a, b) => a.name.localeCompare(b.name));
                
                // 添加图片到容器
                folderGroups[folderPath].forEach((file, index) => {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'image-item';
                    
                    // 创建图片元素但不直接设置src
                    const img = document.createElement('img');
                    img.alt = file.name;
                    
                    // 创建加载动画
                    const loadingDiv = document.createElement('div');
                    loadingDiv.className = 'image-loading';
                    
                    // 使用FileReader读取图片
                    const reader = new FileReader();
                    
                    reader.onload = (event) => {
                        // 存储图片数据
                        const imageData = {
                            url: event.target.result,
                            name: file.name,
                            folder: folderPath,
                            index: index
                        };
                        allImagesData.push(imageData);
                        
                        // 设置data-src属性用于懒加载
                        img.dataset.src = event.target.result;
                        
                        // 如果支持Intersection Observer，使用它
                        if (observer) {
                            observer.observe(img);
                        } else {
                            // 否则立即添加到加载队列
                            addToLoadingQueue(img);
                        }
                        
                        // 添加点击事件 - 修复浮图功能
                        imageItem.addEventListener('click', () => {
                            // 获取当前文件夹的所有图片
                            currentFolderImages = allImagesData.filter(imgData => imgData.folder === folderPath);
                            // 找到当前点击的图片索引
                            currentImageIndex = currentFolderImages.findIndex(imgData => imgData.url === event.target.result);
                            
                            zoomOverlay.classList.add('active');
                            
                            // 显示图片计数
                            showZoomImage();
                            
                            // 预加载相邻图片
                            preloadAdjacentImages();
                        });
                    };

                    reader.readAsDataURL(file);
                    
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'image-name';
                    nameDiv.textContent = file.name;
                    
                    imageItem.appendChild(loadingDiv);
                    imageItem.appendChild(img);
                    imageItem.appendChild(nameDiv);
                    imagesContainer.appendChild(imageItem);
                });
                
                groupDiv.appendChild(imagesContainer);
                imageContainer.appendChild(groupDiv);
            });
            
            // 应用当前布局
            applyLayout(currentLayout);
            
            // 初始检查可见图片
            setTimeout(() => {
                checkVisibleImages();
                processLoadingQueue();
            }, 100);
        });
        
        // 添加滚动事件监听器以实现懒加载
        window.addEventListener('scroll', () => {
            if (!observer) {
                checkVisibleImages();
            }
        });
        
        // 添加调整大小事件监听器
        window.addEventListener('resize', () => {
            if (!observer) {
                checkVisibleImages();
            }
        });
        
        // 添加键盘导航支持
        document.addEventListener('keydown', (e) => {
            if (zoomOverlay.classList.contains('active')) {
                if (e.key === 'ArrowLeft') {
                    // 上一张
                    if (currentImageIndex > 0) {
                        currentImageIndex--;
                        showZoomImage();
                        preloadAdjacentImages();
                    }
                } else if (e.key === 'ArrowRight') {
                    // 下一张
                    if (currentImageIndex < currentFolderImages.length - 1) {
                        currentImageIndex++;
                        showZoomImage();
                        preloadAdjacentImages();
                    }
                } else if (e.key === 'Escape') {
                    // 关闭
                    zoomOverlay.classList.remove('active');
                }
            }
        });
    </script>
</body>
</html>